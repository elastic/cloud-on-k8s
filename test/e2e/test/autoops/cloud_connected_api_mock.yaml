---
# Cloud Connected API Mock for E2E tests
# This file contains all resources needed to deploy WireMock as a mock for the Cloud Connected API
apiVersion: v1
kind: ConfigMap
metadata:
  name: wiremock-{{ .TestRun }}-mappings
  namespace: {{ .E2ENamespace }}
  labels:
    app.kubernetes.io/name: wiremock-cloud-connected-api
    app.kubernetes.io/instance: wiremock-{{ .TestRun }}
data:
  # Create Cluster API - Success (201)
  create-cluster-success.json: |
    {
      "priority": 1,
      "request": {
        "method": "POST",
        "urlPathPattern": "/api/v1/cloud-connected/clusters",
        "bodyPatterns": [
          {
            "matchesJsonPath": "$.self_managed_cluster"
          },
          {
            "matchesJsonPath": "$.license"
          }
        ]
      },
      "response": {
        "status": 201,
        "headers": {
          "Content-Type": "application/json",
          "ETag": "\"{{ "{{randomValue type='UUID'}}" }}\""
        },
        "transformers": ["response-template"],
        "bodyFileName": "create-cluster-response.json"
      }
    }

  # Create Cluster API - Bad Request (400) - Missing self_managed_cluster
  create-cluster-bad-request.json: |
    {
      "priority": 3,
      "request": {
        "method": "POST",
        "urlPathPattern": "/api/v1/cloud-connected/clusters",
        "bodyPatterns": [
          {
            "doesNotMatch": ".*self_managed_cluster.*"
          }
        ]
      },
      "response": {
        "status": 400,
        "headers": {
          "Content-Type": "application/json"
        },
        "jsonBody": {
          "errors": [
            {
              "message": "Missing required field: self_managed_cluster",
              "code": "validation.required_field_missing"
            }
          ]
        }
      }
    }

  # Create Cluster API - Bad Request (400) - Missing license
  create-cluster-missing-license.json: |
    {
      "priority": 3,
      "request": {
        "method": "POST",
        "urlPathPattern": "/api/v1/cloud-connected/clusters",
        "bodyPatterns": [
          {
            "matchesJsonPath": "$.self_managed_cluster"
          },
          {
            "doesNotMatch": ".*\"license\".*"
          }
        ]
      },
      "response": {
        "status": 400,
        "headers": {
          "Content-Type": "application/json"
        },
        "jsonBody": {
          "errors": [
            {
              "message": "Missing required field: license",
              "code": "validation.required_field_missing"
            }
          ]
        }
      }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: wiremock-{{ .TestRun }}-files
  namespace: {{ .E2ENamespace }}
  labels:
    app.kubernetes.io/name: wiremock-cloud-connected-api
    app.kubernetes.io/instance: wiremock-{{ .TestRun }}
data:
  # Response body for create cluster (201)
  create-cluster-response.json: |
    {
      "id": "{{ "{{randomValue length=32 type='ALPHANUMERIC' lowercase=true}}" }}",
      "name": "{{ "{{jsonPath request.body '$.name' default='My Cloud Connected Cluster'}}" }}",
      "metadata": {
        "created_at": "{{ "{{now format=\"yyyy-MM-dd'T'HH:mm:ss.SSSXXX\"}}" }}",
        "created_by": "1014289666002276",
        "organization_id": "198583657190"
      },
      "self_managed_cluster": {
        "id": "{{ "{{jsonPath request.body '$.self_managed_cluster.id'}}" }}",
        "name": "{{ "{{jsonPath request.body '$.self_managed_cluster.name'}}" }}",
        "version": "{{ "{{jsonPath request.body '$.self_managed_cluster.version'}}" }}"
      },
      "license": {
        "type": "{{ "{{jsonPath request.body '$.license.type'}}" }}",
        "uid": "{{ "{{jsonPath request.body '$.license.uid'}}" }}"
      },
      "services": {
        "auto_ops": {
          "enabled": false,
          "support": {
            "supported": true,
            "valid_license_types": ["basic", "platinum", "enterprise"],
            "minimum_stack_version": "9.2.0"
          },
          "config": {
            "region_id": "aws-us-east-1"
          },
          "metadata": {
            "documentation_url": "https://www.elastic.co/docs/deploy-manage/monitor/autoops/cc-autoops-as-cloud-connected",
            "connect_url": "https://application.auto-ops.cloud.elastic.co/organizations/198583657190/connect-autoops"
          },
          "subscription": {
            "required": false
          }
        },
        "eis": {
          "enabled": false,
          "support": {
            "supported": true,
            "valid_license_types": ["basic", "platinum", "enterprise"],
            "minimum_stack_version": "9.2.0"
          },
          "metadata": {
            "documentation_url": "https://www.elastic.co"
          },
          "subscription": {
            "required": true
          }
        }
      },
      "key": "VXNlci1JRDoxMjM0NTY3ODkwYWJjZGVmMTIzNDU2Nzg5MGFiY2RlZg=="
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wiremock-{{ .TestRun }}
  namespace: {{ .E2ENamespace }}
  labels:
    app.kubernetes.io/name: wiremock-cloud-connected-api
    app.kubernetes.io/instance: wiremock-{{ .TestRun }}
    app.kubernetes.io/component: mock-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: wiremock-cloud-connected-api
      app.kubernetes.io/instance: wiremock-{{ .TestRun }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: wiremock-cloud-connected-api
        app.kubernetes.io/instance: wiremock-{{ .TestRun }}
        app.kubernetes.io/component: mock-service
      annotations:
        checksum/mappings: "{{ .TestRun }}-mappings"
        checksum/files: "{{ .TestRun }}-files"
    spec:
      automountServiceAccountToken: false
      securityContext:
{{- if not .OcpCluster }}
        runAsUser: 1000
{{- end }}
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: wiremock
          image: "wiremock/wiremock:3.3.1"
          imagePullPolicy: IfNotPresent
          env:
            - name: JAVA_OPTS
              value: "-Xms32m -Xmx64m -XX:+UseSerialGC -XX:MaxMetaspaceSize=32m"
          args:
            - "--port=8080"
            - "--global-response-templating"
            - "--max-request-journal-entries=20"
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /__admin/health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /__admin/health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            limits:
              memory: 128Mi
            requests:
              cpu: "50m"
              memory: 64Mi
          volumeMounts:
            - name: mappings
              mountPath: /home/wiremock/mappings
              readOnly: true
            - name: files
              mountPath: /home/wiremock/__files
              readOnly: true
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
      volumes:
        - name: mappings
          configMap:
            name: wiremock-{{ .TestRun }}-mappings
        - name: files
          configMap:
            name: wiremock-{{ .TestRun }}-files
      terminationGracePeriodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: wiremock-{{ .TestRun }}
  namespace: {{ .E2ENamespace }}
  labels:
    app.kubernetes.io/name: wiremock-cloud-connected-api
    app.kubernetes.io/instance: wiremock-{{ .TestRun }}
    app.kubernetes.io/component: mock-service
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: wiremock-cloud-connected-api
    app.kubernetes.io/instance: wiremock-{{ .TestRun }}
  ports:
    - name: http
      protocol: TCP
      port: 8080
      targetPort: http
