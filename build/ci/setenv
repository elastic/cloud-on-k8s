#!/usr/bin/env bash

# Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
# or more contributor license agreements. Licensed under the Elastic License;
# you may not use this file except in compliance with the Elastic License.

# Script to set environment variables to run CI tasks.

set -eu

REGISTRY=docker.elastic.co
IMG_NAME=eck-operator

ROOT=$(dirname $0)/../..
ENV_FILE=$ROOT/.env

# variables that can be provided in a CI context
WORKSPACE=${WORKSPACE:-$ROOT}
TAG_NAME=${TAG_NAME:-""}

reset() {
    rm -f $ENV_FILE
}

# Prepare variables to write in the .env file.
# The presence of the TAG_NAME env var indicates the build of a release, conversely
# without TAG_NAME it is a nightly build.
setup_vars() {
    if [[ ${TAG_NAME} != "" ]]; then
        # release build
        REPOSITORY=eck
        SNAPSHOT=false
        VERSION=${TAG_NAME}
    else
        # nightly build
        REPOSITORY=eck-snapshots
        SNAPSHOT=true
        VERSION=$(cat $WORKSPACE/VERSION)-$(date +%F)-$(git rev-parse --short --verify HEAD)
    fi

    OPERATOR_IMAGE=${REGISTRY}/${REPOSITORY}/${IMG_NAME}:${VERSION}
}

add_var() {
    local key=$1 value=${2:-}

    if [[ $value != "" ]]; then
        echo "$key = $value" >> $ENV_FILE
    fi
}

# Write env vars in an .env file which is sourced by the root Makefile
write_env() {
    # reset
    > $ENV_FILE

    # add base variables
    add_var REGISTRY        ${REGISTRY}
    add_var IMG_NAME        ${IMG_NAME}
    add_var REPOSITORY      ${REPOSITORY}
    add_var SNAPSHOT        ${SNAPSHOT}
    add_var VERSION         ${VERSION}
    add_var OPERATOR_IMAGE  ${OPERATOR_IMAGE}

    # add optional variables if defined
    add_var GCLOUD_PROJECT        ${GCLOUD_PROJECT:-}
    add_var ELASTIC_DOCKER_LOGIN  ${ELASTIC_DOCKER_LOGIN:-}
}

main() {
    setup_vars
    write_env
}

main "$@"
