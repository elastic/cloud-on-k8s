agents:
  image: docker.elastic.co/ci-agent-images/cloud-k8s-operator/buildkite-agent:latest
  memory: "4G"


steps:

  - group: "aks"
    steps:

      - label: "e2e/tanzu"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/aks
          - .buildkite/scripts/common/get-test-artifacts.sh
          - make -C .ci TARGET="run-deployer e2e-run" ci
        artifact_paths:
          - "eck-diagnostic-*.zip"

      - wait: ~
        continue_on_failure: true

      - label: "cleanup"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
        commands:
          - .ci/setenvconfig cleanup/aks
          - make -C .ci TARGET=run-deployer ci

  - group: "ocp"
    steps:

      - label: "e2e/tanzu"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/ocp 4.7.49
          - .buildkite/scripts/common/get-test-artifacts.sh
          - make -C .ci TARGET="run-deployer e2e-run" ci
        artifact_paths:
          - "eck-diagnostic-*.zip"

      - wait: ~
        continue_on_failure: true

      - label: "cleanup"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
        commands:
          - .ci/setenvconfig cleanup/ocp 4.7.49
          - make -C .ci TARGET=run-deployer ci

  - group: "tanzu"
    steps:

      - label: "e2e/tanzu"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/tanzu
          - .buildkite/scripts/common/get-test-artifacts.sh
          - make -C .ci TARGET="run-deployer e2e-run" ci
        artifact_paths:
          - "eck-diagnostic-*.zip"

      - wait: ~
        continue_on_failure: true

      - label: "cleanup"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
        commands:
          - .ci/setenvconfig cleanup/tanzu
          - make -C .ci TARGET=run-deployer ci