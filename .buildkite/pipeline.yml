agents:
  image: docker.elastic.co/ci-agent-images/cloud-k8s-operator/buildkite-agent:abaeba8c
  cpu: "4"
  memory: "2G"

env:
  VAULT_ROOT_PATH: secret/ci/elastic-cloud-on-k8s

steps:

  - label: ":buildkite: image build"
    agents:
      image: "docker.elastic.co/employees/ramonbutter/serverless-docker-builder:0.1.0"
    env:
      DOCKER_REGISTRY_VAULT_PATH: secret/ci/elastic-cloud-on-k8s/docker-registry-elastic
    commands:
      - buildkite-agent meta-data set BUILD_TYPE eck
      - make -C /agent generate-docker-images

  - label: ":buildkite: dev image build"
    agents:
      image: "docker.elastic.co/employees/ramonbutter/serverless-docker-builder:0.1.0"
    env:
      DOCKER_REGISTRY_VAULT_PATH: secret/ci/elastic-cloud-on-k8s/docker-registry-elastic
      BUILD_LICENSE_PUBKEY: "dev"
      OPERATOR_VERSION_SUFFIX: "dev"
    commands:
      - buildkite-agent meta-data set BUILD_TYPE eck-dev
      - make -C /agent generate-docker-images

  - label: ":buildkite: UBI image build"
    agents:
      image: "docker.elastic.co/employees/ramonbutter/serverless-docker-builder:0.1.0"
    env:
      DOCKER_REGISTRY_VAULT_PATH: secret/ci/elastic-cloud-on-k8s/docker-registry-elastic
      ENABLE_UBI_BUILD: true
    commands:
      - buildkite-agent meta-data set BUILD_TYPE eck-ubi
      - make -C /agent generate-docker-images

  - label: ":buildkite: UBI image build"
    agents:
      image: "docker.elastic.co/employees/ramonbutter/serverless-docker-builder:0.1.0"
    env:
      DOCKER_REGISTRY_VAULT_PATH: secret/ci/elastic-cloud-on-k8s/docker-registry-elastic
      ENABLE_UBI_BUILD: true
    commands:
      - buildkite-agent meta-data set BUILD_TYPE eck-ubi-fips
      - make -C /agent generate-docker-images

  - label: ":buildkite: FIPS image build"
    agents:
      image: "docker.elastic.co/employees/ramonbutter/serverless-docker-builder:0.1.0"
    env:
      DOCKER_REGISTRY_VAULT_PATH: secret/ci/elastic-cloud-on-k8s/docker-registry-elastic
      ENABLE_FIPS_BUILD: true
    commands:
      - buildkite-agent meta-data set BUILD_TYPE eck-fips
      - make -C /agent generate-docker-images

  # - group: checks
  #   steps:

  #     - label: ":go: lint"
  #       command: "make lint check-local-changes"
  #       agents:
  #         cpu: "6"
  #         memory: "6G"

  #     - label: ":go: generate"
  #       command: "make generate check-local-changes"

  #     - label: ":go: checks"
  #       commands:
  #         - "make check-license-header check-predicates shellcheck reattach-pv"
  #         - env -i .buildkite/scripts/build/setenv_test.sh

  # - group: tests
  #   steps:

  #     - label: ":go: unit-tests"
  #       command: "make unit-xml"
  #       agents:
  #         memory: "4G"

  #     - label: ":go: integration-tests"
  #       command: "make integration-xml"
  #       agents:
  #         memory: "4G"

  #     - label: ":go: manifest-gen-tests"
  #       command: "make manifest-gen-test"

  #     - label: ":go: helm-tests"
  #       command: "make helm-test"

  # - label: ":buildkite:"
  #   command: buildkite-agent pipeline upload .buildkite/pipeline-build.yml

  # - label: ":buildkite:"
  #   command: buildkite-agent pipeline upload .buildkite/pipeline-e2e-tests.yml

  # - label: ":buildkite:"
  #   command: buildkite-agent pipeline upload .buildkite/pipeline-release.yml
