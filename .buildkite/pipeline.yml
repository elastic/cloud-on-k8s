agents:
  image: docker.elastic.co/ci-agent-images/cloud-k8s-operator/buildkite-agent:01671ac6
  cpu: "4"
  memory: "2G"

env:
  VAULT_ROOT_PATH: secret/ci/elastic-cloud-on-k8s

steps:

  - group: checks
    steps:

      - label: ":go: lint"
        command: "make lint check-local-changes"
        agents:
          cpu: "6"
          memory: "6G"

      - label: ":go: generate"
        command: "make generate check-local-changes"

      - label: ":go: checks"
        commands: "make check-license-header check-predicates shellcheck reattach-pv"

  - group: tests
    steps:

      - label: ":go: unit-tests"
        command: "make unit-xml"
        agents:
          memory: "4G"

      - label: ":go: integration-tests"
        command: "make integration-xml"
        agents:
          memory: "4G"

      - label: ":go: manifest-gen-tests"
        command: "make manifest-gen-test"

      - label: ":go: helm-tests"
        command: "make helm-test"

  - label: ":buildkite:"
    command: buildkite-agent pipeline upload .buildkite/pipeline-build.yml

  - label: ":buildkite:"
    command: buildkite-agent pipeline upload .buildkite/pipeline-e2e-tests.yml

  - label: ":buildkite:"
    depends_on:
      - "operator-image-build"
    if: build.message =~ /^buildkite test .*release.*/
    env:
      DRY_RUN: true
    command: buildkite-agent pipeline upload .buildkite/pipeline-release.yml

  - label: ":buildkite:"
    depends_on:
      - "operator-image-build"
    if: |
      ( build.branch == "main" && build.source != "schedule" )
      || build.tag != null
      || build.message =~ /^release eck/
    env:
      DRY_RUN: false
    command: buildkite-agent pipeline upload .buildkite/pipeline-release.yml
