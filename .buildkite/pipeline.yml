agents:
  image: docker.elastic.co/ci-agent-images/cloud-k8s-operator/buildkite-agent:01671ac6
  cpu: "4"
  memory: "2G"

steps:

  - label: "mock e2e-tests.json upload"
    commands:
      - cd .buildkite/e2e-tests-json
      - buildkite-agent artifact upload "*.json"
      - exit 42
    artifact_paths: ""

  - wait: ~
    continue_on_failure: true

  - label: aggregate tests-results
    commands:
      - |
        cd .buildkite/e2e/reporter

        mkdir reports/
        buildkite-agent artifact download "*.json" reports/

        set +e
        for f in reports/e2e-tests-*.json; do
          ../../scripts/test/convert-e2e-tests-json-to-xml.sh "$$f"
        done

        go run main.go reports/ > report.md

        [ $$? -ne 0 ] && style=error || style=success
        set -e

        cat report.md | buildkite-agent annotate --style "$$style"

        if [[ $$style == "error" ]]; then

        notif_message() {
          # yolo
          grep "<summary>" report.md | sed -r "s@.*<code>([^/]*).*</code> ~ (.*)</summary>@\1 \2@g" | sed "s/^/            /"
        }

        cat <<- YAML | tee notify.yml
        steps:
          - label: ""
            if: build.branch != "main"
            command: false
            notify:
              - slack:
                  channels:
                    - "#test-notify"
                  message: |
        $$(notif_message)
        YAML

        buildkite-agent pipeline upload notify.yml

        fi

    artifact_paths:
      - ".buildkite/e2e/reporter/report.md"
      - ".buildkite/e2e/reporter/notify.yml"
