steps:

  - group: "aks"
    steps:

      - label: "aks"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/aks
          - make -C .ci TARGET="run-deployer e2e-run" ci
        artifact_paths:
          - "eck-diagnostics-*.zip"

      - wait: ~
        continue_on_failure: true

      - label: "cleanup"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
        commands:
          - .ci/setenvconfig cleanup/aks
          - make -C .ci TARGET=run-deployer ci

  - group: "eks"
    steps:

      - label: "eks build cluster"
        key: "eks-nightly-e2e-tests-build-cluster"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/eks
          - make run-deployer

      - label: "eks"
        agents:
          memory: "4G"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/eks
          - make set-kubeconfig
          - make e2e-run
        artifact_paths:
          - "eck-diagnostics-*.zip"
        depends_on:
          - "eks-nightly-e2e-tests-build-cluster"

      - wait: ~
        continue_on_failure: true

      - label: "cleanup"
        commands:
          - .ci/setenvconfig cleanup/eks
          - make run-deployer

  # - group: "eks-arm"
  #   steps:

  #     - label: "e2e/eks-arm"
  #       commands:
  #         - .ci/setenvconfig e2e/main
  #         - .ci/setenvconfig e2e/eks-arm
  #         - make run-deployer
  #         - make e2e-run
  #       artifact_paths:
  #         - "eck-diagnostics-*.zip"

  #     - wait: ~
  #       continue_on_failure: true

  #     - label: "cleanup"
  #       commands:
  #         - .ci/setenvconfig cleanup/eks-arm
  #         - make run-deployer

  - group: "gke"
    steps:

      - label: "gke 1.21 build cluster"
        key: "gke121-nightly-e2e-tests-build-cluster"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/gke-k8s-versions 1.21
          - make run-deployer

      - label: "gke 1.21"
        agents:
          memory: "4G"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/gke-k8s-versions 1.21
          - make set-kubeconfig
          - make e2e-run
        artifact_paths:
          - "eck-diagnostics-*.zip"
        depends_on:
          - "gke121-nightly-e2e-tests-build-cluster"

      - label: "gke 1.22 build cluster"
        key: "gke122-nightly-e2e-tests-build-cluster"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/gke-k8s-versions 1.22
          - make run-deployer

      - label: "gke 1.22"
        agents:
          memory: "4G"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/gke-k8s-versions 1.22
          - make set-kubeconfig
          - make e2e-run
        artifact_paths:
          - "eck-diagnostics-*.zip"
        depends_on:
          - "gke122-nightly-e2e-tests-build-cluster"

      - label: "gke 1.23 build cluster"
        key: "gke123-nightly-e2e-tests-build-cluster"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/gke-k8s-versions 1.23
          - make run-deployer

      - label: "gke 1.23"
        agents:
          memory: "4G"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/gke-k8s-versions 1.23
          - make set-kubeconfig
          - make e2e-run
        artifact_paths:
          - "eck-diagnostics-*.zip"
        depends_on:
          - "gke123-nightly-e2e-tests-build-cluster"

      - wait: ~
        continue_on_failure: true

      - label: "cleanup"
        commands:
          - .ci/setenvconfig cleanup/gke 1.21
          - make run-deployer

      - label: "cleanup"
        commands:
          - .ci/setenvconfig cleanup/gke 1.22
          - make run-deployer

      - label: "cleanup"
        commands:
          - .ci/setenvconfig cleanup/gke 1.23
          - make run-deployer

  - group: "kind"
    steps:

      - label: "kind 1.20"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
          machineType: "n1-standard-16"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/kind-k8s-versions kindest/node:v1.20.15@sha256:6f2d011dffe182bad80b85f6c00e8ca9d86b5b8922cdf433d53575c4c5212248 0.14.0 ipv4
          - make -C .ci TARGET="run-deployer e2e-run" ci
        artifact_paths:
          - "eck-diagnostics-*.zip"

      - label: "kind 1.21"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
          machineType: "n1-standard-16"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/kind-k8s-versions kindest/node:v1.21.12@sha256:f316b33dd88f8196379f38feb80545ef3ed44d9197dca1bfd48bcb1583210207 0.14.0 ipv4
          - make -C .ci TARGET="run-deployer e2e-run" ci
        artifact_paths:
          - "eck-diagnostics-*.zip"

      - label: "kind 1.22 ipv4"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
          machineType: "n1-standard-16"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/kind-k8s-versions kindest/node:v1.22.9@sha256:8135260b959dfe320206eb36b3aeda9cffcb262f4b44cda6b33f7bb73f453105 0.14.0 ipv4
          - make -C .ci TARGET="run-deployer e2e-run" ci
        artifact_paths:
          - "eck-diagnostics-*.zip"

      - label: "kind 1.22 ipv6"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
          machineType: "n1-standard-16"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/kind-k8s-versions kindest/node:v1.22.9@sha256:8135260b959dfe320206eb36b3aeda9cffcb262f4b44cda6b33f7bb73f453105 0.14.0 ipv6
          - make -C .ci TARGET="run-deployer e2e-run" ci
        artifact_paths:
          - "eck-diagnostics-*.zip"

      - label: "kind 1.23 ipv4"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
          machineType: "n1-standard-16"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/kind-k8s-versions kindest/node:v1.23.6@sha256:b1fa224cc6c7ff32455e0b1fd9cbfd3d3bc87ecaa8fcb06961ed1afb3db0f9ae 0.14.0 ipv4
          - make -C .ci TARGET="run-deployer e2e-run" ci
        artifact_paths:
          - "eck-diagnostics-*.zip"

      - label: "kind 1.23 ipv6"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
          machineType: "n1-standard-16"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/kind-k8s-versions kindest/node:v1.23.6@sha256:b1fa224cc6c7ff32455e0b1fd9cbfd3d3bc87ecaa8fcb06961ed1afb3db0f9ae 0.14.0 ipv6
          - make -C .ci TARGET="run-deployer e2e-run" ci
        artifact_paths:
          - "eck-diagnostics-*.zip"

      - label: "kind 1.24 ipv4"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
          machineType: "n1-standard-16"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/kind-k8s-versions kindest/node:v1.24.1@sha256:11276ce4763d5600379c0104c4cb51bf7420c8c02937708e958ad68d08e0910c 0.14.0 ipv4
          - make -C .ci TARGET="run-deployer e2e-run" ci
        artifact_paths:
          - "eck-diagnostics-*.zip"

      - label: "kind 1.24 ipv6"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
          machineType: "n1-standard-16"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/kind-k8s-versions kindest/node:v1.24.1@sha256:11276ce4763d5600379c0104c4cb51bf7420c8c02937708e958ad68d08e0910c 0.14.0 ipv6
          - make -C .ci TARGET="run-deployer e2e-run" ci
        artifact_paths:
          - "eck-diagnostics-*.zip"

  - group: "ocp"
    steps:

      # - label: "ocp 4.7"
      #   agents:
      #     provider: "gcp"
      #     image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
      #   commands:
      #     - .ci/setenvconfig e2e/main
      #     - .ci/setenvconfig e2e/ocp 4.7.49
      #     - make -C .ci TARGET="run-deployer e2e-run" ci
      #   artifact_paths:
      #     - "eck-diagnostics-*.zip"

      # - label: "ocp 4.8"
      #   agents:
      #     provider: "gcp"
      #     image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
      #   commands:
      #     - .ci/setenvconfig e2e/main
      #     - .ci/setenvconfig e2e/ocp 4.8.50
      #     - make -C .ci TARGET="run-deployer e2e-run" ci
      #   artifact_paths:
      #     - "eck-diagnostics-*.zip"

      # - label: "ocp 4.9"
      #   agents:
      #     provider: "gcp"
      #     image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
      #   commands:
      #     - .ci/setenvconfig e2e/main
      #     - .ci/setenvconfig e2e/ocp 4.9.48
      #     - make -C .ci TARGET="run-deployer e2e-run" ci
      #   artifact_paths:
      #     - "eck-diagnostics-*.zip"

      # - label: "ocp 4.10"
      #   agents:
      #     provider: "gcp"
      #     image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
      #   commands:
      #     - .ci/setenvconfig e2e/main
      #     - .ci/setenvconfig e2e/ocp 4.10.34
      #     - make -C .ci TARGET="run-deployer e2e-run" ci
      #   artifact_paths:
      #     - "eck-diagnostics-*.zip"

      - label: "ocp 4.11"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/ocp 4.11.5
          - make -C .ci TARGET="run-deployer e2e-run" ci
        artifact_paths:
          - "eck-diagnostics-*.zip"

      - wait: ~
        continue_on_failure: true

      # - label: "cleanup"
      #   agents:
      #     provider: "gcp"
      #     image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
      #   commands:
      #     - .ci/setenvconfig cleanup/ocp 4.7.49
      #     - make -C .ci TARGET=run-deployer ci

      # - label: "cleanup"
      #   agents:
      #     provider: "gcp"
      #     image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
      #   commands:
      #     - .ci/setenvconfig cleanup/ocp 4.8.50
      #     - make -C .ci TARGET=run-deployer ci

      # - label: "cleanup"
      #   agents:
      #     provider: "gcp"
      #     image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
      #   commands:
      #     - .ci/setenvconfig cleanup/ocp 4.9.48
      #     - make -C .ci TARGET=run-deployer ci

      # - label: "cleanup"
      #   agents:
      #     provider: "gcp"
      #     image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
      #   commands:
      #     - .ci/setenvconfig cleanup/ocp 4.10.34
      #     - make -C .ci TARGET=run-deployer ci

      - label: "cleanup"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
        commands:
          - .ci/setenvconfig cleanup/ocp 4.11.5
          - make -C .ci TARGET=run-deployer ci

  - group: "tanzu"
    steps:

      - label: "e2e/tanzu"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/tanzu
          - make -C .ci TARGET="run-deployer e2e-run" ci
        artifact_paths:
          - "eck-diagnostics-*.zip"

      - wait: ~
        continue_on_failure: true

      - label: "cleanup"
        agents:
          provider: "gcp"
          image: "family/elastic-buildkite-agent-ubuntu-2004-lts"
        commands:
          - .ci/setenvconfig cleanup/tanzu
          - make -C .ci TARGET=run-deployer ci

  - group: "resilience"
    steps:

      - label: "resilience build cluster"
        key: "resilience-nightly-e2e-tests-build-cluster"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/resilience
          - make run-deployer

      - label: "e2e/resilience"
        agents:
          memory: "4G"
        commands:
          - .ci/setenvconfig e2e/main
          - .ci/setenvconfig e2e/resilience
          - make set-kubeconfig
          - make e2e-run
        artifact_paths:
          - "eck-diagnostics-*.zip"
        depends_on:
          - "resilience-nightly-e2e-tests-build-cluster"

      - wait: ~
        continue_on_failure: true

      - label: "cleanup"
        commands:
          - .ci/setenvconfig cleanup/resilience
          - make run-deployer
