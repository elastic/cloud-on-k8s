agents:
  image: docker.elastic.co/ci-agent-images/cloud-k8s-operator/buildkite-agent:9203b231
  memory: 2G

steps:

  - label: ":go: build deployer"
    key: "build-deployer"
    if: |
      build.message == "buildkite run e2e test cleanup"
    commands:
      - make build-deployer
      - buildkite-agent artifact upload hack/deployer/deployer

  - label: ":broom: e2e test cluster cleanup gke"
    if: |
      build.message == "buildkite run e2e test cleanup"
    depends_on:
      - "build-deployer"
    commands:
      - buildkite-agent artifact download "hack/deployer/deployer" /usr/local/
      - chmod u+x /usr/local/hack/deployer/deployer
      - /usr/local/hack/deployer/deployer cleanup --plans-file hack/deployer/config/plans.yml --provider gke

  - label: ":broom: e2e test cluster cleanup aks"
    if: |
      build.message == "buildkite run e2e test cleanup"
    depends_on:
      - "build-deployer"
    commands:
      - buildkite-agent artifact download "hack/deployer/deployer" /tmp
      - chmod u+x /tmp/hack/deployer/deployer
      - /tmp/hack/deployer/deployer cleanup --plans-file hack/deployer/config/plans.yml --provider aks

  - label: ":broom: e2e test cluster cleanup eks"
    if: |
      build.message == "buildkite run e2e test cleanup"
    depends_on:
      - "build-deployer"
    commands:
      - buildkite-agent artifact download "hack/deployer/deployer" /tmp
      - chmod u+x /tmp/hack/deployer/deployer
      - /tmp/hack/deployer/deployer cleanup --plans-file hack/deployer/config/plans.yml --provider eks
