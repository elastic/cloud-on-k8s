env:
  BUILD_PLATFORM: "linux/amd64,linux/arm64"
  BUILD_TRIGGER: "pr"
  BUILD_FLAVORS: "eck,eck-dev,eck-fips,eck-ubi8,eck-ubi8-fips"

steps:

  - label: "build push amd64 image"
    if: build.env("BUILD_PLATFORM") =~ /amd64/
    command:
      - ./gen-drivah.toml.sh
      - drivah build --push .
      #- buildkite-agent annotate "üê¨  <code>$${IMAGE}-amd64</code> pushed<br>" --style 'success' --context 'ctx-build-success' --append
    agents:
      image: "docker.elastic.co/ci-agent-images/drivah:0.18.1"
      ephemeralStorage: "20G"
      memory: "4G"
    plugins:
      - elastic/vault-docker-login#v0.3.0:
          secret_path: "secret/ci/elastic-cloud-on-k8s/docker-registry-elastic"
    artifact_paths:
      - "images-*"

  - label: "build push arm64 image"
    if: build.env("BUILD_PLATFORM") =~ /arm64/
    command:
      - ./gen-drivah.toml.sh
      - drivah build --push .
      #- buildkite-agent annotate "üêã  <code>$${IMAGE}-arm64</code> pushed<br>" --style 'success' --context 'ctx-build-success' --append
    agents:
      provider: "aws"
      imagePrefix: "drivah-ubuntu-2204-aarch64"
      instanceType: "m6g.xlarge"
    plugins:
      - elastic/vault-docker-login#v0.3.0:
          secret_path: "secret/ci/elastic-cloud-on-k8s/docker-registry-elastic"
    artifact_paths:
      - "images-*"

  - wait: ~

  - label: "push manifest"
    command:
      - buildkite-agent artifact download "images-*" .
      #- .buildkite/scripts/build/setenv.sh
      #- source .env
      # - buildah manifest create $${IMAGE} $$(sed -e "s|linux/|$${IMAGE}-|g" -e "s|,| |g" <<< $$BUILD_PLATFORM)
      # - buildah manifest push $${IMAGE} "docker://$${IMAGE}"
      # - buildah manifest inspect $${IMAGE}
      # - buildkite-agent annotate "üê≥  <code>$${IMAGE}</code> pushed" --style 'success' --context 'ctx-build-success' --append
    agents:
      image: "docker.elastic.co/ci-agent-images/drivah:0.18.1"
      ephemeralStorage: "20G"
    plugins:
      - elastic/vault-docker-login#v0.3.0:
          secret_path: "secret/ci/elastic-cloud-on-k8s/docker-registry-elastic"