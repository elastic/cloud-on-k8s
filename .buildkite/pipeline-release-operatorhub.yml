steps:
  - group: redhat-release
    steps:

      - label: "build operatorhub tool"
        key: "build-operatorhub-tool"
        commands:
          - cd hack/operatorhub
          - make build
          - chmod u+x bin/operatorhub
          - buildkite-agent artifact upload "bin/operator*"

      - label: "Generate CRDs"
        key: "generate-crds"
        depends_on:
          - "build-operatorhub-tool"
        commands:
          - make generate-crds-v1
        artifact_paths:
        - "config/*.yaml"

      - label: "run container push"
        key: "redhat-container-push"
        depends_on:
          - "generate-crds"
        commands:
          - buildkite-agent artifact download "bin/operator*" /usr/local/
          - chmod u+x /usr/local/bin/operatorhub
          - /usr/local/bin/operatorhub container push --dry-run=\$DRY_RUN

      - label: "run container preflight"
        key: "redhat-preflight"
        depends_on:
          - "redhat-container-push"
        commands:
          - .buildkite/scripts/release/operatorhub.sh preflight

      - label: "run remaining release"
        key: "redhat-release"
        depends_on:
          - "redhat-preflight"
        commands:
          - .buildkite/scripts/release/operatorhub.sh release