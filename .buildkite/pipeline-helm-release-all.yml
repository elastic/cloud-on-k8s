agents:
  image: docker.io/library/golang:1.19.3
  memory: "4G"

steps:

  - group: "release all helm charts"
    steps:

      - label: "release all helm charts dev"
        key: helm-release-all-dev
        commands:
          - cd hack/helm/release
          # ignoring stdout to avoid "go: downloading ..." output.
          - make build 2> /dev/null
          - cp bin/releaser /tmp/releaser
          # if a branch is sent as an environment variable, change to that branch.
          - if [[ ! -z "$$HELM_BRANCH" ]]; then echo "checking out $$HELM_BRANCH branch" && git checkout $$HELM_BRANCH ; fi
          - VAULT_ROOT_PATH="secret/ci/elastic-cloud-on-k8s" HELM_CREDENTIALS_FILE=/tmp/credentials.json /tmp/releaser --env=dev --charts-dir=../../../deploy --enable-vault

      - label: "release all helm charts prod"
        depends_on:
          - "helm-release-all-dev"
        commands:
          - cd hack/helm/release
          # ignoring stdout to avoid "go: downloading ..." output.
          - make build 2> /dev/null
          - cp bin/releaser /tmp/releaser
          # if a branch is sent as an environment variable, change to that branch.
          - if [[ ! -z "$$HELM_BRANCH" ]]; then echo "checking out $$HELM_BRANCH branch" && git checkout $$HELM_BRANCH ; fi
          - VAULT_ROOT_PATH="secret/ci/elastic-cloud-on-k8s" HELM_CREDENTIALS_FILE=/tmp/credentials.json /tmp/releaser --env=prod --charts-dir=../../../deploy --enable-vault
