steps:

  - group: "autopilot-tests"
    steps:

      # for commits in all branches (PR, release) except main
      - label: ":buildkite: autopilot"
        depends_on:
          - "operator-image-build"
          - "e2e-tests-image-build"
        if: |
            ( build.branch != "main" )
            && build.env("GITHUB_PR_TRIGGER_COMMENT") !~ /^buildkite test this -[fm]/
            && build.message =~ /^buildkite test autopilot.*/
        command: |
          cd .buildkite/e2e/pipeline-gen && go build -o pipeline-gen
          cat <<DEF | ./pipeline-gen | buildkite-agent pipeline upload
          - label: gke-autopilot
            fixed:
              E2E_PROVIDER: gke-autopilot
              TESTS_MATCH: TestAutopilot
          DEF
